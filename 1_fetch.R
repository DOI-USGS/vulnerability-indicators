source("1_fetch/src/fetch_utils.R")

p1_targets <- list(
  ##### Vulnerability indicators data #####
  tar_target(p1_sb_id,
             '63f79d49d34e4f7eda456572'),
  ##### Vulnerability indicators metadata #####
  tar_target(p1_vul_ind_xml,
             download_from_sb(sb_id = p1_sb_id,
                              filename = 'Uncertainty_Summary.xml',
                              dest_dir = '1_fetch/out'),
             format = 'file'),
  ##### Uncertainty statistics for the indicators #####
  tar_target(p1_unc_stats_csv,
             download_from_sb(sb_id = p1_sb_id,
                              filename = 'Uncertainty_Summary.csv',
                              dest_dir = '1_fetch/out'),
             format = 'file'),
  tar_target(p1_unc_stats,
             readr::read_csv(p1_unc_stats_csv) |> 
               janitor::clean_names()
             ),
  ##### Uncertainty Aggregated, Raw data provided by Oronde Drakes in relation to "Social vulnerability and water insecurity in the western United States: A systematic review of framings, indicators, and uncertainty" (in review) #####
  tar_target(p1_unc_agg_csv_path,
             "1_fetch/in/uncertainty_aggregated_raw_data.csv"),
  tar_target(p1_unc_agg,
             readr::read_csv(p1_unc_agg_csv_path, skip = 1) |> 
               janitor::clean_names()
             ),
  ### Load in census data #### 
  # census_api_key("XXXXXXXXXXXXXXXXXXXXXXXXX", install = TRUE)
  # readRenviron("~/.Renviron")
  # Take a peak at the available census variables
  tar_target(p1_census_vars,
             tidycensus::load_variables(year = 2022, dataset = "acs1")),
  tar_target(p1_census_states,
             c('Washington', 'Oregon', 'California', 'Idaho', 'Nevada',
               'Utah', 'Arizona', 'Montana', 'Wyoming', 'Colorado',
               'New Mexico', 'North Dakota', 'South Dakota', 'Nebraska', 'Kansas',
               'Oklahoma', 'Texas', 'Minnesota', 'Iowa', 'Missouri',
               'Arkansas', 'Louisiana')),
  tar_target(p1_proj,
             '+proj=aea +lat_0=23 +lon_0=-96 +lat_1=29.5 +lat_2=45.5 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +type=crs'),
  tar_target(p1_conus_sf,
             tigris::states(cb = TRUE) |> 
               st_transform(p1_proj) |> 
               mutate(group = case_when(
                 STUSPS %in% c(state.abb[!state.abb %in% c('AK', 'HI')], 'DC') ~ 'CONUS',
                 STUSPS %in% c('GU', 'MP') ~ 'GU_MP',
                 STUSPS %in% c('PR', 'VI') ~ 'PR_VI',
                 TRUE ~ STUSPS
               )) |> 
               filter(group %in% c('CONUS')) |> 
               rmapshaper::ms_simplify(keep = 0.2) |> 
               filter(NAME %in% p1_census_states))
  )
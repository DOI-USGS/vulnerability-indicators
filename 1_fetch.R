source("1_fetch/src/fetch_utils.R")

p1_targets <- list(
  ##### Vulnerability indicators data #####
  tar_target(p1_out_data,
             "1_fetch/out/"),
  tar_target(p1_sb_id,
             '63f79d49d34e4f7eda456572'),
  ##### Vulnerability indicators metadata #####
  tar_target(p1_vul_ind_xml,
             sb_initialize_and_download(sb_id = p1_sb_id,
                              names = 'Uncertainty_Summary.xml',
                              destinations = paste0(p1_out_data, "Uncertainty_Summary.xml")),
             format = 'file'),
  ##### Uncertainty statistics for the indicators #####
  tar_target(p1_unc_stats_csv,
             sb_initialize_and_download(sb_id = p1_sb_id,
                              names = 'Uncertainty_Summary.csv',
                              destinations = paste0(p1_out_data, "Uncertainty_Summary.csv")),
             format = 'file'),
  tar_target(p1_unc_stats,
             readr::read_csv(p1_unc_stats_csv) |> 
               janitor::clean_names()
             ),
  tar_target(p1_census_states,
             c('Washington', 'Oregon', 'California', 'Idaho', 'Nevada',
               'Utah', 'Arizona', 'Montana', 'Wyoming', 'Colorado',
               'New Mexico', 'North Dakota', 'South Dakota', 'Nebraska', 'Kansas',
               'Oklahoma', 'Texas', 'Minnesota', 'Iowa', 'Missouri',
               'Arkansas', 'Louisiana')),
  tar_target(p1_proj,
             'EPSG:5070'),
  tar_target(p1_conus_sf,
             tigris::states(cb = TRUE) |> 
               st_transform(p1_proj) |> 
               mutate(group = case_when(
                 STUSPS %in% c(state.abb[!state.abb %in% c('AK', 'HI')], 'DC') ~ 'CONUS',
                 STUSPS %in% c('GU', 'MP') ~ 'GU_MP',
                 STUSPS %in% c('PR', 'VI') ~ 'PR_VI',
                 TRUE ~ STUSPS
               )) |> 
               filter(group %in% c('CONUS')) |> 
               rmapshaper::ms_simplify(keep = 0.2) |> 
               filter(NAME %in% p1_census_states)),
  # raster data for population density
  tar_target(p1_pop_density_raster_zip,
             '1_fetch/in/gpw-v4-population-count-rev11_2020_30_sec_tif.zip'),
  tar_target(p1_pop_density_raster_tif,
             unzip(p1_pop_density_raster_zip, 'gpw_v4_population_count_rev11_2020_30_sec.tif',
                   exdir = p1_out_data)),
  # raster data for impervious surfaces
  tar_target(p1_imp_surf_zip,
             sb_initialize_and_download(sb_id = "664e0da6d34e702fe8744579",
                              names = 'Annual_NLCD_FctImp_2022_CU_C1V0.zip',
                              destinations = paste0(p1_out_data, "Annual_NLCD_FctImp_2022_CU_C1V0.zip")),
             format = 'file'),
  tar_target(p1_imp_surf_tif,
             unzip(p1_imp_surf_zip, 'Annual_NLCD_FctImp_2022_CU_C1V0.tif',
                   exdir = p1_out_data))
  )
  
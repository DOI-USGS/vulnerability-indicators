source('2_process/src/data_utils.R')

p2_targets <- list(
  # Confirming raw data matches `p1_unc_stats` from SB
  tar_target(p2_unc_agg_summary,
             p1_unc_agg |>
               group_by(dimension, determinant, indicator) |>
               summarize(across(c(contains('related'),
                                  contains('unknown'),
                                  contains('significant')),
                                list(total = ~sum(.x, na.rm=TRUE)))) |> 
               mutate(evidence_val = positively_related_total + negatively_related_total +
                        unrelated_total + unknown_direction_total)
             ),
  # Based on metadata:
  # Amt of evidence: Small = total_studies < 5; Medium = total_studies 5-9; Large,total_studies = > 9
  # Amt of agreement: Low = < 50% of models; Medium = >50% & <74% of models; High = >74% of models; NA if the level of agreement could not be calculated as indicator was measured only once.
  tar_target(p2_top_trend_stats,
             p2_unc_agg_summary |>
               dplyr::select(dimension, determinant, indicator, 
                      positively_related_total, negatively_related_total, unrelated_total, 
                      unknown_direction_total) |>
               pivot_longer(!c(dimension,determinant,indicator)) |>
               group_by(dimension, determinant, indicator) |>
               slice_max(value) |>
               rename(sig_name = name, sig_value = value)
             ),
  # Join `p2_unc_agg_summary` to top trends to get percentages of agreement and evidence
  tar_target(p2_agree_evid_stats,
             p2_unc_agg_summary |>
               left_join(p2_top_trend_stats) |>
               mutate(level_agreement = 100*(sig_value/evidence_val))
             ),
  # Process census data for variables of interest
  tar_target(p2_tot_pop,
             get_census_data(geography = "county",
                             variable = "B01003_001",
                             states = p1_census_states,
                             year = 2022,
                             proj = p1_proj) |> 
               dplyr::select(geoid, estimate) |> 
               st_drop_geometry() |> 
               rename(tot_pop = estimate)),
  # Median household income in the past 12 months (B19013_001)
  tar_target(p2_med_income_sf,
             get_census_data(geography = "county",
                        variable = "B19013_001",
                        states = p1_census_states,
                        year = 2022,
                        proj = p1_proj)),
  # Estimate!!Total:!!Black or African American alone (B02001_003)
  tar_target(p2_tot_black_sf,
             get_census_data(geography = "county",
                             variable = "B02001_003",
                             states = p1_census_states,
                             year = 2022,
                             proj = p1_proj)),
  # Percent Black population
  tar_target(p2_perc_black_sf,
             process_perc(tot_pop = p2_tot_pop,
                          tot_var = p2_tot_black_sf)),
  # Estimate!!Total Hispanic or Latino Origin by Race (B03001_003)
  tar_target(p2_tot_latino_sf,
             get_census_data(geography = "county",
                             variable = "B03001_003",
                             states = p1_census_states,
                             year = 2022,
                             proj = p1_proj)),
  # Percent Latino population
  tar_target(p2_perc_latino_sf,
             process_perc(tot_pop = p2_tot_pop,
                          tot_var = p2_tot_latino_sf)),
  #  Estimate!!Total:!!Male (B01001_002)
  tar_target(p2_tot_male_sf,
             get_census_data(geography = "county",
                             variable = "B01001_002",
                             states = p1_census_states,
                             year = 2022,
                             proj = p1_proj)),
  # Estimate!!Total:!!female (B01001_026)
  tar_target(p2_tot_female_sf,
             get_census_data(geography = "county",
                             variable = "B01001_026",
                             states = p1_census_states,
                             year = 2022,
                             proj = p1_proj))
  )
# source('2_process/src/spatial_utils.R')
source('2_process/src/data_utils.R')

p2_targets <- list(
  # Confirming raw data matches `p1_unc_stats` from SB
  tar_target(p2_unc_agg_summary,
             p1_unc_agg |>
               group_by(dimension, determinant, indicator) |>
               summarize(across(c(contains('related'),
                                  contains('unknown'),
                                  contains('significant')),
                                list(total = ~sum(.x, na.rm=TRUE)))) |> 
               mutate(evidence_val = positively_related_total + negatively_related_total +
                        unrelated_total + unknown_direction_total)
             ),
  # Based on metadata:
  # Amt of evidence: Small = total_studies < 5; Medium = total_studies 5-9; Large,total_studies = > 9
  # Amt of agreement: Low = < 50% of models; Medium = >50% & <74% of models; High = >74% of models; NA if the level of agreement could not be calculated as indicator was measured only once.
  tar_target(p2_top_trend_stats,
             p2_unc_agg_summary |>
               dplyr::select(dimension, determinant, indicator, 
                      positively_related_total, negatively_related_total, unrelated_total, 
                      unknown_direction_total) |>
               pivot_longer(!c(dimension,determinant,indicator)) |>
               group_by(dimension, determinant, indicator) |>
               slice_max(value) |>
               rename(sig_name = name, sig_value = value)
             ),
  # Join `p2_unc_agg_summary` to top trends to get percentages of agreement and evidence
  tar_target(p2_agree_evid_stats,
             p2_unc_agg_summary |>
               left_join(p2_top_trend_stats) |>
               mutate(level_agreement = 100*(sig_value/evidence_val))
             )
  )
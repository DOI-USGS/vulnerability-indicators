<template>
  <section id="dendogram">
    <div id="grid-container-interactive">
      <div id="title">
        <h3 class="grid-title">
          <p>Dendrogram Title</p>
        </h3>
      </div>
      <div id="text">
        <p>
          Dendogram might go here. Lorem ipsum dolor sit amet consectetur adipisicing elit. Nostrum
          doloremque sunt distinctio itaque dolorum ducimus provident minima mollitia recusandae!
        </p>
      </div>
      <div id="dendrogram-container"></div>
    </div>
  </section>
</template>

<script setup>
import { onMounted, ref } from 'vue'
import * as d3 from 'd3'

// global variables
const publicPath = import.meta.env.BASE_URL
const data = ref([])

// load data and then make chart
onMounted(() => {
  loadData().then(() => {
    if (data.value.length > 0) {
      transformData()
      createDendrogram()
    }
  })
})

async function loadData() {
  // console.log(data);
  data.value = await d3.csv(publicPath + 'p2_agree_evid_stats.csv', (d) => {
    d.level_agreement = +d.level_agreement
    d.evidence_val = +d.evidence_val
    return d
  })
}

function transformData() {
  const nestedData = data.value.reduce((acc, item) => {
    // check if dimension already exists in accumulator
    let dimensionObj = acc.find((d) => d.name === item.dimension)

    // if no dimension exists, create and add to acc
    if (!dimensionObj) {
      dimensionObj = {
        name: item.dimension,
        children: []
      }
      acc.push(dimensionObj)
    }

    // check if determinant already exists in dimension object
    let determinantObj = dimensionObj.children.find(d => d.name === item.determinant);

    // iff not, create new determinant object and add to determinants array
    if (!determinantObj) {
      determinantObj = {
        name: item.determinant,
        children: []
      };
      dimensionObj.children.push(determinantObj);
    }

     // Add the current item to the indicators array
     determinantObj.children.push({
      name: item.indicator,
      positively_related_total: item.positively_related_total,
      negatively_related_total: item.negatively_related_total,
      unrelated_total: item.unrelated_total,
      unknown_direction_total: item.unknown_direction_total,
      unknown_total: item.unknown_total,
      significant_total: item.significant_total,
      not_significant_total: item.not_significant_total,
      evidence_val: item.evidence_val,
      sig_name: item.sig_name,
      sig_value: item.sig_value,
      level_agreement: item.level_agreement
    });

    // Sort the children array of determinantObj based on evidence_val in descending order
    // we may not want this
    determinantObj.children.sort((a, b) => b.evidence_val - a.evidence_val);

    return acc
  }, [])
  console.log(nestedData)
  return nestedData
}

function createDendrogram() {
  const width = 1000
  const height = 800
  const margin = { top: 20, right: 20, bottom: 20, left: 20 }

  const svg = d3
    .select('#dendrogram-container')
    .append('svg')
    .attr('width', width)
    .attr('height', height)
}
</script>

<style scoped lang="scss">
//  #grid-container-interactive {
//     display: grid;
//     padding: 20px 0 20px 0;
//     gap: 5px;
//     grid-template-columns: 65vw 25vw;
//     grid-template-rows: max-content max-content max-content max-content;
//     grid-template-areas:
//       "title title"
//       "text text"
//       "dendrogram dendrogram";
//     justify-content: center;
//     margin: auto;
//     max-width: 90vw;
//     min-width: 90vw;
//     // @media screen and (max-height: 770px) {
//     //   row-gap: 4vh;
//     //   margin: 4rem 0rem 5rem 0rem;
//     // }
//   }

//   #grid-title {
//     grid-area: title;
//     align-self: center;
//   }

//   #text {
//     grid-area: text;
//   }

//   #dendrogram-container {
//     pointer-events: none;
//     grid-area: map;
//     height: 100%;
//     max-height: 70vh;
//   }
#dendrogram-container {
  text-align: center;
  position: relative;
}

#dendrogram-container svg {
  max-width: 100%;
  max-height: 100%;
  height: auto; /* Maintain aspect ratio */
  display: inline-block;
}
</style>
